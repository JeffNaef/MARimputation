<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Hands-On Part</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Examples_files/libs/clipboard/clipboard.min.js"></script>
<script src="Examples_files/libs/quarto-html/quarto.js"></script>
<script src="Examples_files/libs/quarto-html/popper.min.js"></script>
<script src="Examples_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Examples_files/libs/quarto-html/anchor.min.js"></script>
<link href="Examples_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Examples_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Examples_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Examples_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Examples_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Hands-On Part</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>The following real data example is adapted to a large extend from the guidance on <a href="https://rmisstastic.netlify.app/tutorials/josse_bookdown_dataanalysismissingr_2020#11">Rmisstastic</a>_descriptive_statistics_with_missing_values):</p>
<section id="air-quality-data" class="level1">
<h1>Air Quality Data</h1>
<p>Air pollution is currently one of the most serious public health worries worldwide. Many epidemiological studies have proved the influence that some chemical compounds, such as sulphur dioxide (SO2), nitrogen dioxide (NO2), ozone (O3) can have on our health. Associations set up to monitor air quality are active all over the world to measure the concentration of these pollutants.</p>
<p>The data set we use here is a small subset of a cleaned version of air pollution measurements in the US. For more details, I refer to the Appendix C of <a href="https://jmlr.org/papers/v23/21-0585.html">the following paper</a>. In this example, I actually induced missing values here, so that we have full control over the missing mechanism and access to the true data.</p>
<p>We first load a real (prepared) data set:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mice)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Naniar provides principled, tidy ways to summarise, visualise, and manipulate missing data with minimal deviations from the workflows in ggplot2 and tidy data.</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(naniar)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(VIM)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(FactoMineR)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>X<span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data.csv"</span>, <span class="at">header=</span>T, <span class="at">row.names=</span><span class="dv">1</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>Xstar<span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"fulldata.csv"</span>, <span class="at">header=</span>T, <span class="at">row.names=</span><span class="dv">1</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  max_PM2.5 max_O3 max_PM10  Longitude Latitude Elevation Land.Use_AGRICULTURAL
1      4.75  0.027       11 -106.58520 35.13430      1591                     0
2      7.15  0.055       25 -120.68028 38.20185        NA                     1
3      1.45  0.044        8 -105.30353 42.76697      1508                     1
4      7.00  0.058       20  -70.74802 43.07537         8                     0
5     12.00  0.017       NA -112.09577 33.50383        NA                     0
6      5.40  0.049       17  -85.89804 38.06091       135                     0
  Land.Use_COMMERCIAL Land.Use_INDUSTRIAL Location.Setting_RURAL
1                   0                   0                      0
2                   0                   0                      1
3                   0                   0                      1
4                   0                   0                      0
5                   0                   0                      0
6                   0                   0                      0
  Location.Setting_SUBURBAN
1                         0
2                         0
3                         0
4                         0
5                         0
6                         1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Xstar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  max_PM2.5 max_O3 max_PM10  Longitude Latitude Elevation Land.Use_AGRICULTURAL
1      4.75  0.027       11 -106.58520 35.13430      1591                     0
2      7.15  0.055       25 -120.68028 38.20185       310                     1
3      1.45  0.044        8 -105.30353 42.76697      1508                     1
4      7.00  0.058       20  -70.74802 43.07537         8                     0
5     12.00  0.017       15 -112.09577 33.50383       343                     0
6      5.40  0.049       17  -85.89804 38.06091       135                     0
  Land.Use_COMMERCIAL Land.Use_INDUSTRIAL Location.Setting_RURAL
1                   0                   0                      0
2                   0                   0                      1
3                   0                   0                      1
4                   0                   0                      0
5                   0                   0                      0
6                   0                   0                      0
  Location.Setting_SUBURBAN
1                         0
2                         0
3                         0
4                         0
5                         0
6                         1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   max_PM2.5          max_O3          max_PM10        Longitude      
 Min.   :-3.300   Min.   :0.0010   Min.   :  0.00   Min.   :-124.18  
 1st Qu.: 4.100   1st Qu.:0.0330   1st Qu.:  9.00   1st Qu.:-117.33  
 Median : 6.200   Median :0.0410   Median : 15.00   Median :-106.51  
 Mean   : 7.332   Mean   :0.0413   Mean   : 18.31   Mean   :-102.33  
 3rd Qu.: 9.200   3rd Qu.:0.0490   3rd Qu.: 23.00   3rd Qu.: -88.22  
 Max.   :56.333   Max.   :0.0910   Max.   :143.00   Max.   : -68.26  
 NA's   :159      NA's   :162      NA's   :338      NA's   :159      
    Latitude       Elevation    Land.Use_AGRICULTURAL Land.Use_COMMERCIAL
 Min.   :26.05   Min.   : -14   Min.   :0.000         Min.   :0.0000     
 1st Qu.:34.49   1st Qu.:  68   1st Qu.:0.000         1st Qu.:0.0000     
 Median :38.20   Median : 269   Median :0.000         Median :0.0000     
 Mean   :38.35   Mean   : 430   Mean   :0.125         Mean   :0.3115     
 3rd Qu.:41.30   3rd Qu.: 571   3rd Qu.:0.000         3rd Qu.:1.0000     
 Max.   :48.64   Max.   :2195   Max.   :1.000         Max.   :1.0000     
                 NA's   :353                                             
 Land.Use_INDUSTRIAL Location.Setting_RURAL Location.Setting_SUBURBAN
 Min.   :0.00        Min.   :0.000          Min.   :0.000            
 1st Qu.:0.00        1st Qu.:0.000          1st Qu.:0.000            
 Median :0.00        Median :0.000          Median :0.000            
 Mean   :0.03        Mean   :0.193          Mean   :0.428            
 3rd Qu.:0.00        3rd Qu.:0.000          3rd Qu.:1.000            
 Max.   :1.00        Max.   :1.000          Max.   :1.000            
                                                                     </code></pre>
</div>
</div>
<section id="descriptive-statistics-with-missing-values" class="level2">
<h2 class="anchored" data-anchor-id="descriptive-statistics-with-missing-values"><strong>1) Descriptive statistics with missing values</strong></h2>
<p>We start by inspecting various plots for the missing values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>res<span class="ot">&lt;-</span><span class="fu">summary</span>(<span class="fu">aggr</span>(X, <span class="at">sortVar=</span><span class="cn">TRUE</span>))<span class="sc">$</span>combinations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Examples_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Variables sorted by number of missings: 
                  Variable  Count
                 Elevation 0.1765
                  max_PM10 0.1690
                    max_O3 0.0810
                 max_PM2.5 0.0795
                 Longitude 0.0795
                  Latitude 0.0000
     Land.Use_AGRICULTURAL 0.0000
       Land.Use_COMMERCIAL 0.0000
       Land.Use_INDUSTRIAL 0.0000
    Location.Setting_RURAL 0.0000
 Location.Setting_SUBURBAN 0.0000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>res[<span class="fu">rev</span>(<span class="fu">order</span>(res[,<span class="dv">2</span>])),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           Combinations Count Percent
1 0:0:0:0:0:0:0:0:0:0:0  1008   50.40
5 0:0:1:0:0:1:0:0:0:0:0   179    8.95
2 0:0:0:0:0:1:0:0:0:0:0   174    8.70
6 0:1:0:0:0:0:0:0:0:0:0   162    8.10
7 1:0:0:0:0:0:0:0:0:0:0   159    7.95
4 0:0:1:0:0:0:0:0:0:0:0   159    7.95
3 0:0:0:1:0:0:0:0:0:0:0   159    7.95</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#The VIM function matrixplot creates a matrix plot in which all cells of a X matrix are visualized by rectangles. Available X is coded according to a continuous color scheme (gray scale), while missing/imputed X is visualized by a clearly distinguishable color (red). If you use Rstudio the plot is not interactive (there are the warnings), but if you use R directly, you can click on a column of your choice: the rows are sorted (decreasing order) of the values of this column. This is useful to check if there is an association between the value of a variable and the missingness of another one.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Creating the res variable renders a nice plot, showing the percentage of missing values for each variable. Moreover the next command nicely shows the patterns (M), as well as their frequency of occurring in the data set. In particular, we can further visualize the pattern using the matrixplot function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">matrixplot</span>(X, <span class="at">sortby =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Examples_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The VIM function&nbsp;<strong>marginplot</strong>&nbsp;creates a scatterplot with additional information on the missing values. If you plot the variables (x,y), the points with no missing values are represented as in a standard scatterplot. The points for which x (resp. y) is missing are represented in red along the y (resp. x) axis. In addition, boxplots of the x and y variables are represented along the axes with and without missing values (in red all variables x where y is missing, in blue all variables x where y is observed).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">marginplot</span>(X[,<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Examples_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This plot can be used to check whether MCAR might hold. Under MCAR, the distribution of a variable when another variable is missing should always be the same. Under MAR this can be violated as we have seen (distribution shifts!). This plotting is a convenient way to check this a bit.</p>
<p>There are many more plotting possibilities with VIM, as demonstrated e.g., in 2012ADAC.pdf (tuwien.ac.at).</p>
</section>
<section id="imputation" class="level2">
<h2 class="anchored" data-anchor-id="imputation"><strong>2) Imputation</strong></h2>
<p>We now finally use the <a href="https://cran.r-project.org/web/packages/mice/mice.pdf">mice</a> package for imputation. We consider several methods and then start by choosing the best one according to the new I-Score. As the best version of the score not only scores one imputation but an imputation method itself for this dataset, we need to define a function for each:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mice)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"Iscore.R"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"miceDRF.R"</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>X<span class="ot">&lt;-</span><span class="fu">as.matrix</span>(X)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>methods<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"pmm"</span>,      <span class="co"># mice-pmm</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>           <span class="st">"cart"</span>,     <span class="co"># mice-cart</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>           <span class="st">"sample"</span>,   <span class="co">#mice-sample</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>           <span class="st">"norm.nob"</span>, <span class="co"># Gaussian Imputation</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>           <span class="st">"DRF"</span>)      <span class="co"># mice-DRF</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  imputationfuncs<span class="ot">&lt;-</span><span class="fu">list</span>()</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (method <span class="cf">in</span> methods) {</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a closure to capture the current value of 'method'</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  imputationfuncs[[method]] <span class="ot">&lt;-</span> <span class="fu">local</span>({</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Capture the current value of 'method'</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    current_method <span class="ot">&lt;-</span> method</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the function that uses the captured 'current_method'</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(X, m, <span class="at">maxit =</span> <span class="dv">5</span>) {</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Perform mice imputation using the current method</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>      tmp <span class="ot">&lt;-</span> <span class="fu">mice</span>(X, <span class="at">m =</span> m, <span class="at">method =</span> current_method, <span class="at">printFlag =</span> <span class="cn">FALSE</span>, <span class="at">visitSequence =</span> <span class="st">"arabic"</span>, <span class="at">maxit =</span> maxit)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Return the completed datasets</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(mice<span class="sc">::</span><span class="fu">complete</span>(tmp, <span class="at">action =</span> <span class="st">"all"</span>))</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>scoreslist <span class="ot">&lt;-</span> <span class="fu">Iscores_new</span>(X,<span class="at">imputations=</span><span class="cn">NULL</span>, <span class="at">imputationfuncs=</span>imputationfuncs, <span class="at">N=</span><span class="dv">30</span>)  </span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>scores<span class="ot">&lt;-</span><span class="fu">do.call</span>(cbind,<span class="fu">lapply</span>(scoreslist, <span class="cf">function</span>(x) x<span class="sc">$</span>score ))</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(scores)<span class="ot">&lt;-</span>methods</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>scores[<span class="fu">order</span>(scores)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The score considers mice-cart to to be the best method. As a side note however, mice-rf is deemed second best and might have better properties for uncertainty estimation and multiple imputation, thus both should be considered. Here, we go with mice-cart:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>imp.mice <span class="ot">&lt;-</span> <span class="fu">mice</span>(X, <span class="at">m =</span> <span class="dv">10</span>, <span class="at">method =</span> <span class="st">"cart"</span>, <span class="at">printFlag =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since we have the true data in this case, we analyze the imputation method a bit closer:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="do">## This here is not possible without the fully observed data </span><span class="al">###</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>Ximp<span class="ot">&lt;-</span>mice<span class="sc">::</span><span class="fu">complete</span>(imp.mice)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>index1<span class="ot">&lt;-</span><span class="dv">1</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>index2<span class="ot">&lt;-</span><span class="dv">2</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Xstar[<span class="fu">is.na</span>(X[,index1]) <span class="sc">|</span> <span class="fu">is.na</span>(X[,index2]),<span class="fu">c</span>(index1,index2)])</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Ximp[<span class="fu">is.na</span>(X[,index1]) <span class="sc">|</span> <span class="fu">is.na</span>(X[,index2]),<span class="fu">c</span>(index1,index2)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Examples_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Replicating first and second moments</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colMeans</span>(Xstar)<span class="sc">-</span><span class="fu">colMeans</span>(Ximp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                max_PM2.5                    max_O3                  max_PM10 
               0.02988000                0.00006825               -0.08600000 
                Longitude                  Latitude                 Elevation 
              -0.03243501                0.00000000                0.19050000 
    Land.Use_AGRICULTURAL       Land.Use_COMMERCIAL       Land.Use_INDUSTRIAL 
               0.00000000                0.00000000                0.00000000 
   Location.Setting_RURAL Location.Setting_SUBURBAN 
               0.00000000                0.00000000 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">norm</span>(<span class="fu">cov</span>(Xstar) <span class="sc">-</span> <span class="fu">cov</span>(Ximp))<span class="sc">/</span><span class="fu">norm</span>(<span class="fu">cov</span>(Xstar))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.003579673</code></pre>
</div>
</div>
</section>
<section id="analyse" class="level2">
<h2 class="anchored" data-anchor-id="analyse"><strong>3) Analyse</strong></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply a regression to the multiple imputation</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>lm.mice.out <span class="ot">&lt;-</span> <span class="fu">with</span>(imp.mice, <span class="fu">lm</span>(max_O3 <span class="sc">~</span> max_PM2<span class="fl">.5</span> <span class="sc">+</span>Longitude <span class="sc">+</span>Latitude <span class="sc">+</span>Elevation <span class="sc">+</span>Land.Use_AGRICULTURAL<span class="sc">+</span>Land.Use_COMMERCIAL<span class="sc">+</span>Land.Use_INDUSTRIAL<span class="sc">+</span>Location.Setting_RURAL<span class="sc">+</span>Location.Setting_SUBURBAN))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Use Rubins Rules to aggregate the estimates</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>res<span class="ot">&lt;-</span><span class="fu">pool</span>(lm.mice.out)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                        term      estimate    std.error   statistic        df
1                (Intercept)  3.929489e-02 3.757540e-03 10.45761017  988.7992
2                  max_PM2.5  1.159419e-04 5.819645e-05  1.99224975  212.2122
3                  Longitude -9.544637e-06 2.051607e-05 -0.46522743 1130.0248
4                   Latitude -3.530013e-06 7.328762e-05 -0.04816657 1291.7748
5                  Elevation -1.088580e-06 6.931284e-07 -1.57053192 1458.9054
6      Land.Use_AGRICULTURAL -7.699460e-05 1.464395e-03 -0.05257776  546.3266
7        Land.Use_COMMERCIAL  7.415961e-04 7.020305e-04  1.05635886 1087.1609
8        Land.Use_INDUSTRIAL -1.900513e-03 1.832379e-03 -1.03718315  772.5075
9     Location.Setting_RURAL  1.871732e-03 1.275582e-03  1.46735561  235.1812
10 Location.Setting_SUBURBAN  8.131452e-04 7.029311e-04  1.15679215  555.0273
        p.value
1  2.385199e-24
2  4.762533e-02
3  6.418582e-01
4  9.615909e-01
5  1.165083e-01
6  9.580876e-01
7  2.910390e-01
8  2.999750e-01
9  1.436154e-01
10 2.478549e-01</code></pre>
</div>
</div>
<p>Importantly, this works here because we have all the ingredients for the pool function, which are (according to ?pool):</p>
<ul>
<li><p>the estimates of the model;</p></li>
<li><p>the standard error of each estimate;</p></li>
<li><p>the residual degrees of freedom of the model.</p></li>
</ul>
<p>Just to double check, we also perform the regression on <span class="math inline">\(X^*\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">## This here is not possible without the fully observed data </span><span class="al">###</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>res.not.attainable<span class="ot">&lt;-</span><span class="fu">lm</span>(max_O3 <span class="sc">~</span> max_PM2<span class="fl">.5</span> <span class="sc">+</span>Longitude <span class="sc">+</span>Latitude <span class="sc">+</span>Elevation <span class="sc">+</span>Land.Use_AGRICULTURAL<span class="sc">+</span>Land.Use_COMMERCIAL<span class="sc">+</span>Land.Use_INDUSTRIAL<span class="sc">+</span>Location.Setting_RURAL<span class="sc">+</span>Location.Setting_SUBURBAN, <span class="at">data=</span><span class="fu">as.data.frame</span>(Xstar))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(res.not.attainable)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = max_O3 ~ max_PM2.5 + Longitude + Latitude + Elevation + 
    Land.Use_AGRICULTURAL + Land.Use_COMMERCIAL + Land.Use_INDUSTRIAL + 
    Location.Setting_RURAL + Location.Setting_SUBURBAN, data = as.data.frame(Xstar))

Residuals:
      Min        1Q    Median        3Q       Max 
-0.043412 -0.008181 -0.000635  0.007901  0.049148 

Coefficients:
                            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                4.092e-02  3.627e-03  11.282   &lt;2e-16 ***
max_PM2.5                  1.305e-04  5.333e-05   2.447   0.0145 *  
Longitude                  1.314e-08  1.988e-05   0.001   0.9995    
Latitude                  -2.495e-05  7.142e-05  -0.349   0.7269    
Elevation                 -9.333e-07  6.769e-07  -1.379   0.1681    
Land.Use_AGRICULTURAL      3.083e-04  1.382e-03   0.223   0.8235    
Land.Use_COMMERCIAL        5.986e-04  6.794e-04   0.881   0.3784    
Land.Use_INDUSTRIAL       -1.777e-03  1.751e-03  -1.015   0.3103    
Location.Setting_RURAL     1.883e-03  1.152e-03   1.634   0.1023    
Location.Setting_SUBURBAN  8.635e-04  6.632e-04   1.302   0.1931    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.01288 on 1990 degrees of freedom
Multiple R-squared:  0.007379,  Adjusted R-squared:  0.00289 
F-statistic: 1.644 on 9 and 1990 DF,  p-value: 0.09762</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="fu">round</span>( (res<span class="sc">$</span>pooled<span class="sc">$</span>estimate<span class="sc">-</span>res.not.attainable<span class="sc">$</span>coefficients)<span class="sc">/</span>res.not.attainable<span class="sc">$</span>coefficients, <span class="dv">3</span>)  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                              [,1]
(Intercept)                 -0.040
max_PM2.5                   -0.111
Longitude                 -727.113
Latitude                    -0.859
Elevation                    0.166
Land.Use_AGRICULTURAL       -1.250
Land.Use_COMMERCIAL          0.239
Land.Use_INDUSTRIAL          0.069
Location.Setting_RURAL      -0.006
Location.Setting_SUBURBAN   -0.058</code></pre>
</div>
</div>
<p>Of course there are many more challenges, especially also for data that may be partly dependent (for instance repeat measurement or panel data). Most importantly, mice-cart is awesome, but it does not model the uncertainty of the missing imputation itself. As such it is technically not a proper imputation method, as one part of the uncertainty is missing. This could be an issue for confidence intervals and p-values especially in smaller samples. We also refer to the provided links for more information. In particular also the task view on <a href="https://cran.r-project.org/web/views/MissingData.html">missing data</a>.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>